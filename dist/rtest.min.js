L.CanvasOverlay=L.Class.extend({initialize:function(e,t){this._userDrawFunc=e,L.setOptions(this,t)},params:function(e){return L.setOptions(this,e),this},drawing:function(e){return this._userDrawFunc=e,this},canvas:function(){return this._canvas},redraw:function(){return this._frame||(this._frame=L.Util.requestAnimFrame(this._redraw,this)),this},onAdd:function(e){this._map=e,this._canvas=L.DomUtil.create("canvas","leaflet-heatmap-layer");var t=this._map.getSize();this._canvas.width=t.x,this._canvas.height=t.y;var n=this._map.options.zoomAnimation&&L.Browser.any3d;L.DomUtil.addClass(this._canvas,"leaflet-zoom-"+(n?"animated":"hide")),e._panes.overlayPane.appendChild(this._canvas),e.on("moveend",this._reset,this),e.on("resize",this._resize,this),e.options.zoomAnimation&&L.Browser.any3d&&e.on("zoomanim",this._animateZoom,this),this._reset()},onRemove:function(e){e.getPanes().overlayPane.removeChild(this._canvas),e.off("moveend",this._reset,this),e.off("resize",this._resize,this),e.options.zoomAnimation&&e.off("zoomanim",this._animateZoom,this),this_canvas=null},addTo:function(e){return e.addLayer(this),this},_resize:function(e){this._canvas.width=e.newSize.x,this._canvas.height=e.newSize.y},_reset:function(){var e=this._map.containerPointToLayerPoint([0,0]);L.DomUtil.setPosition(this._canvas,e),this._redraw()},_redraw:function(){var e=this._map.getSize(),t=this._map.getBounds(),n=180*e.x/(20037508.34*(t.getEast()-t.getWest())),r=this._map.getZoom();this._userDrawFunc&&this._userDrawFunc(this,{canvas:this._canvas,bounds:t,size:e,zoomScale:n,zoom:r,options:this.options}),this._frame=null},_animateZoom:function(e){var t=this._map.getZoomScale(e.zoom),n=this._map._getCenterOffset(e.center)._multiplyBy(-t).subtract(this._map._getMapPanePos());this._canvas.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(n)+" scale("+t+")"}}),L.canvasOverlay=function(e,t){return new L.CanvasOverlay(e,t)},!function(e){if("object"==typeof exports)module.exports=e();else if("function"==typeof define&&define.amd)define(e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),t.RTree=e()}}(function(){return function e(t,n,r){function o(i,s){if(!n[i]){if(!t[i]){var h="function"==typeof require&&require;if(!s&&h)return h(i,!0);if(a)return a(i,!0);throw new Error("Cannot find module '"+i+"'")}var c=n[i]={exports:{}};t[i][0].call(c.exports,function(e){var n=t[i][1][e];return o(n?n:e)},c,c.exports,e,t,n,r)}return n[i].exports}for(var a="function"==typeof require&&require,i=0;i<r.length;i++)o(r[i]);return o}({1:[function(e,t,n){"use strict";var r=e("./rectangle"),o=function(e,t){if(t&&t.bbox)return{leaf:t,x:t.bbox[0],y:t.bbox[1],w:t.bbox[2]-t.bbox[0],h:t.bbox[3]-t.bbox[1]};for(var n=e.length,r=0,o=new Array(n);n>r;)o[r]=[e[r][0],e[r][1]],r++;var a=o[0];n=o.length,r=1;for(var i={min:[].concat(a),max:[].concat(a)};n>r;)o[r][0]<i.min[0]?i.min[0]=o[r][0]:o[r][0]>i.max[0]&&(i.max[0]=o[r][0]),o[r][1]<i.min[1]?i.min[1]=o[r][1]:o[r][1]>i.max[1]&&(i.max[1]=o[r][1]),r++;var s={x:i.min[0],y:i.min[1],w:i.max[0]-i.min[0],h:i.max[1]-i.min[1]};return t&&(s.leaf=t),s},a={};a.point=function(e,t){return t.insertSubtree({x:e.geometry.coordinates[0],y:e.geometry.coordinates[1],w:0,h:0,leaf:e},t.root)},a.multiPointLineString=function(e,t){return t.insertSubtree(o(e.geometry.coordinates,e),t.root)},a.multiLineStringPolygon=function(e,t){return t.insertSubtree(o(Array.prototype.concat.apply([],e.geometry.coordinates),e),t.root)},a.multiPolygon=function(e,t){return t.insertSubtree(o(Array.prototype.concat.apply([],Array.prototype.concat.apply([],e.geometry.coordinates)),e),t.root)},a.makeRec=function(e){return r(e.x,e.y,e.w,e.h)},a.geometryCollection=function(e,t){if(e.bbox)return t.insertSubtree({leaf:e,x:e.bbox[0],y:e.bbox[1],w:e.bbox[2]-e.bbox[0],h:e.bbox[3]-e.bbox[1]},t.root);for(var n,r=e.geometry.geometries,i=0,s=r.length,h=[];s>i;){switch(n=r[i],n.type){case"Point":h.push(a.makeRec({x:n.coordinates[0],y:n.coordinates[1],w:0,h:0}));break;case"MultiPoint":h.push(a.makeRec(o(n.coordinates)));break;case"LineString":h.push(a.makeRec(o(n.coordinates)));break;case"MultiLineString":h.push(a.makeRec(o(Array.prototype.concat.apply([],n.coordinates))));break;case"Polygon":h.push(a.makeRec(o(Array.prototype.concat.apply([],n.coordinates))));break;case"MultiPolygon":h.push(a.makeRec(o(Array.prototype.concat.apply([],Array.prototype.concat.apply([],n.coordinates)))));break;case"GeometryCollection":r=r.concat(n.geometries),s=r.length}i++}var c=h[0];for(i=1,s=h.length;s>i;)c.expand(h[i]),i++;return t.insertSubtree({leaf:e,x:c.x(),y:c.y(),h:c.h(),w:c.w()},t.root)},n.geoJSON=function(e){var t,n,r=this;if(Array.isArray(e))t=e.slice();else if(e.features&&Array.isArray(e.features))t=e.features.slice();else{if(!(e instanceof Object))throw"this isn't what we're looking for";t=[e]}for(var o=t.length,i=0;o>i;){if(n=t[i],"Feature"===n.type)switch(n.geometry.type){case"Point":a.point(n,r);break;case"MultiPoint":a.multiPointLineString(n,r);break;case"LineString":a.multiPointLineString(n,r);break;case"MultiLineString":a.multiLineStringPolygon(n,r);break;case"Polygon":a.multiLineStringPolygon(n,r);break;case"MultiPolygon":a.multiPolygon(n,r);break;case"GeometryCollection":a.geometryCollection(n,r)}i++}},n.bbox=function(){var e,t,n,r;switch(arguments.length){case 1:e=arguments[0][0][0],t=arguments[0][0][1],n=arguments[0][1][0],r=arguments[0][1][1];break;case 2:e=arguments[0][0],t=arguments[0][1],n=arguments[1][0],r=arguments[1][1];break;case 4:e=arguments[0],t=arguments[1],n=arguments[2],r=arguments[3]}return this.search({x:e,y:t,w:n-e,h:r-t})}},{"./rectangle":3}],2:[function(e,t,n){"use strict";var r=e("./rtree"),o=e("./geojson");r.prototype.bbox=o.bbox,r.prototype.geoJSON=o.geoJSON,r.Rectangle=e("./rectangle"),t.exports=r},{"./geojson":1,"./rectangle":3,"./rtree":4}],3:[function(e,t,n){"use strict";function r(e,t,n,o){if(!(this instanceof r))return new r(e,t,n,o);var a,i,s;e.x?(n=e.w,o=e.h,t=e.y,0!==e.w&&!e.w&&e.x2?(n=e.x2-e.x,o=e.y2-e.y):(n=e.w,o=e.h),e=e.x,a=e+n,i=t+o,s=o+n?!1:!0):(a=e+n,i=t+o,s=o+n?!1:!0),this.x1=this.x=function(){return e},this.y1=this.y=function(){return t},this.x2=function(){return a},this.y2=function(){return i},this.w=function(){return n},this.h=function(){return o},this.p=function(){return s},this.overlap=function(n){return s||n.p()?e<=n.x2()&&a>=n.x()&&t<=n.y2()&&i>=n.y():e<n.x2()&&a>n.x()&&t<n.y2()&&i>n.y()},this.expand=function(r){var s,h,c=r.x(),u=r.y(),l=r.x2(),f=r.y2();return s=e>c?c:e,h=t>u?u:t,n=a>l?a-s:l-s,o=i>f?i-h:f-h,e=s,t=h,this}}r.overlapRectangle=function(e,t){return 0===e.h&&0===e.w||0===t.h&&0===t.w?e.x<=t.x+t.w&&e.x+e.w>=t.x&&e.y<=t.y+t.h&&e.y+e.h>=t.y:e.x<t.x+t.w&&e.x+e.w>t.x&&e.y<t.y+t.h&&e.y+e.h>t.y},r.containsRectangle=function(e,t){return e.x+e.w<=t.x+t.w&&e.x>=t.x&&e.y+e.h<=t.y+t.h&&e.y>=t.y},r.expandRectangle=function(e,t){var n,r,o=e.x+e.w,a=t.x+t.w,i=e.y+e.h,s=t.y+t.h;return n=e.x>t.x?t.x:e.x,r=e.y>t.y?t.y:e.y,o>a?e.w=o-n:e.w=a-n,i>s?e.h=i-r:e.h=s-r,e.x=n,e.y=r,e},r.makeMBR=function(e,t){if(!e.length)return{x:0,y:0,w:0,h:0};t=t||{},t.x=e[0].x,t.y=e[0].y,t.w=e[0].w,t.h=e[0].h;for(var n=1,o=e.length;o>n;n++)r.expandRectangle(t,e[n]);return t},r.squarifiedRatio=function(e,t,n){var r=(e+t)/2,o=e*t,a=o/(r*r);return o*n/a},t.exports=r},{}],4:[function(e,t,n){"use strict";function r(e){if(!(this instanceof r))return new r(e);var t=3,n=6;isNaN(e)||(t=Math.floor(e/2),n=e);var a={x:0,y:0,w:0,h:0,id:"root",nodes:[]};this.root=a;var i=function(e){for(var t,n=e.slice(),r=[];n.length;)t=n.pop(),t.nodes?n=n.concat(t.nodes):t.leaf&&r.push(t);return r},s=function(e,n,r){var a,s,h,c=[],u=[],l=[],f=1;if(!e||!o.overlapRectangle(e,r))return l;var p={x:e.x,y:e.y,w:e.w,h:e.h,target:n};for(u.push(r.nodes.length),c.push(r);c.length>0;){if(a=c.pop(),s=u.pop()-1,"target"in p)for(;s>=0;){if(h=a.nodes[s],o.overlapRectangle(p,h)){if(p.target&&"leaf"in h&&h.leaf===p.target||!p.target&&("leaf"in h||o.containsRectangle(h,p))){l="nodes"in h?i(a.nodes.splice(s,1)):a.nodes.splice(s,1),o.makeMBR(a.nodes,a),delete p.target;break}"nodes"in h&&(f++,u.push(s),c.push(a),a=h,s=h.nodes.length)}s--}else if("nodes"in p){a.nodes.splice(s+1,1),a.nodes.length>0&&o.makeMBR(a.nodes,a);for(var d=0;d<p.nodes.length;d++)g(p.nodes[d],a);p.nodes=[],0===c.length&&a.nodes.length<=1?(p.nodes=y(a,!0,p.nodes,a),a.nodes=[],c.push(a),u.push(1)):c.length>0&&a.nodes.length<t?(p.nodes=y(a,!0,p.nodes,a),a.nodes=[]):delete p.nodes}else o.makeMBR(a.nodes,a);f-=1}return l},h=function(e,t){var n,r=-1,a=[],i=!0;a.push(t);for(var s=t.nodes;i||-1!==r;){i?i=!1:(a.push(s[r]),s=s[r].nodes,r=-1);for(var h=s.length-1;h>=0;h--){var c=s[h];if("leaf"in c){r=-1;break}var u=o.squarifiedRatio(c.w,c.h,c.nodes.length+1),l=Math.max(c.x+c.w,e.x+e.w)-Math.min(c.x,e.x),f=Math.max(c.y+c.h,e.y+e.h)-Math.min(c.y,e.y),y=o.squarifiedRatio(l,f,c.nodes.length+2);(0>r||Math.abs(y-u)<n)&&(n=Math.abs(y-u),r=h)}}return a},c=function(e){for(var t=l(e);e.length>0;)u(e,t[0],t[1]);return t},u=function(e,n,r){for(var a,i,s,h=o.squarifiedRatio(n.w,n.h,n.nodes.length+1),c=o.squarifiedRatio(r.w,r.h,r.nodes.length+1),u=e.length-1;u>=0;u--){var l=e[u],f={};f.x=Math.min(n.x,l.x),f.y=Math.min(n.y,l.y),f.w=Math.max(n.x+n.w,l.x+l.w)-f.x,f.h=Math.max(n.y+n.h,l.y+l.h)-f.y;var y=Math.abs(o.squarifiedRatio(f.w,f.h,n.nodes.length+2)-h),g={};g.x=Math.min(r.x,l.x),g.y=Math.min(r.y,l.y),g.w=Math.max(r.x+r.w,l.x+l.w)-g.x,g.h=Math.max(r.y+r.h,l.y+l.h)-g.y;var p=Math.abs(o.squarifiedRatio(g.w,g.h,r.nodes.length+2)-c);(!i||!a||Math.abs(p-y)<a)&&(i=u,a=Math.abs(p-y),s=y>p?r:n)}var d=e.splice(i,1)[0];n.nodes.length+e.length+1<=t?(n.nodes.push(d),o.expandRectangle(n,d)):r.nodes.length+e.length+1<=t?(r.nodes.push(d),o.expandRectangle(r,d)):(s.nodes.push(d),o.expandRectangle(s,d))},l=function(e){for(var t,n,r=e.length-1,o=0,a=e.length-1,i=0,s=e.length-2;s>=0;s--){var h=e[s];h.x>e[o].x?o=s:h.x+h.w<e[r].x+e[r].w&&(r=s),h.y>e[i].y?i=s:h.y+h.h<e[a].y+e[a].h&&(a=s)}var c=Math.abs(e[r].x+e[r].w-e[o].x),u=Math.abs(e[a].y+e[a].h-e[i].y);return c>u?r>o?(t=e.splice(r,1)[0],n=e.splice(o,1)[0]):(n=e.splice(o,1)[0],t=e.splice(r,1)[0]):a>i?(t=e.splice(a,1)[0],n=e.splice(i,1)[0]):(n=e.splice(i,1)[0],t=e.splice(a,1)[0]),[{x:t.x,y:t.y,w:t.w,h:t.h,nodes:[t]},{x:n.x,y:n.y,w:n.w,h:n.h,nodes:[n]}]},f=function(e,t){return e.nodes=t.nodes,e.x=t.x,e.y=t.y,e.w=t.w,e.h=t.h,e},y=function(e,t,n,r){var a=[];if(!o.overlapRectangle(e,r))return n;for(a.push(r.nodes);a.length>0;)for(var i=a.pop(),s=i.length-1;s>=0;s--){var h=i[s];o.overlapRectangle(e,h)&&("nodes"in h?a.push(h.nodes):"leaf"in h&&(t?n.push(h):n.push(h.leaf)))}return n},g=function(e,t){var r;if(0===t.nodes.length)return t.x=e.x,t.y=e.y,t.w=e.w,t.h=e.h,void t.nodes.push(e);for(var a,i=h(e,t),s=e;i.length>0;){if(r&&"nodes"in r&&0===r.nodes.length){a=r,r=i.pop();for(var u=0;u<r.nodes.length;u++)if(r.nodes[u]===a||0===r.nodes[u].nodes.length){r.nodes.splice(u,1);break}}else r=i.pop();if("leaf"in s||"nodes"in s||Array.isArray(s)){if(Array.isArray(s)){for(var l=0;l<s.length;l++)o.expandRectangle(r,s[l]);r.nodes=r.nodes.concat(s)}else o.expandRectangle(r,s),r.nodes.push(s);if(r.nodes.length<=n)s={x:r.x,y:r.y,w:r.w,h:r.h};else{var f=c(r.nodes);s=f,i.length<1&&(r.nodes.push(f[0]),i.push(r),s=f[1])}}else o.expandRectangle(r,s),s={x:r.x,y:r.y,w:r.w,h:r.h}}};this.insertSubtree=g,this.getTree=function(){return a},this.setTree=function(e,t){return t||(t=a),f(t,e)},this.search=function(e,t,n){return n=n||[],y(e,t,n,a)};var p=function(e){for(var t,n=1,r=[];n>0;)t=s(e,!1,a),n=t.length,r=r.concat(t);return r},d=function(e,t){var n=s(e,t,a);return n};this.remove=function(e,t){return t&&"function"!=typeof t?d(e,t):p(e,t)},this.insert=function(e,t){var n=g({x:e.x,y:e.y,w:e.w,h:e.h,leaf:t},a);return n}}var o=e("./rectangle");r.prototype.toJSON=function(e){return JSON.stringify(this.root,!1,e)},r.fromJSON=function(e){var t=new r;return t.setTree(JSON.parse(e)),t},t.exports=r,"function"!=typeof Array.isArray&&(Array.isArray=function(e){return"object"==typeof e&&"[object Array]"==={}.toString.call(e)})},{"./rectangle":3}]},{},[2])(2)});var map=L.map("map").setView([31.22,121.48],9);L.tileLayer("http://map.geoq.cn/ArcGIS/rest/services/ChinaOnlineStreetPurplishBlue/MapServer/tile/{z}/{y}/{x}",{maxZoom:18,attribution:"geoq"}).addTo(map);var rtree=RTree(10);map.getArea=function(){var e=this.getBounds(),t=e.getSouth(),n=e.getWest(),r=e.getEast()-n,o=e.getNorth()-t;return{x:n,y:t,w:r,h:o}},$.getJSON("./shanghai.geojson",function(e){console.log("sum:"+e.features.length),rtree.geoJSON(e);var t=function(e,t){var n=t.canvas,r=n.getContext("2d");r.clearRect(0,0,n.width,n.height);var o=this;if(o._map.getZoom()>8){console.time("search");var a=rtree.search(map.getArea());console.timeEnd("search"),console.log("search result:"+a.length),console.time("render"),$.each(a,function(e,t){var n=t.geometry.coordinates,a=o._map.latLngToContainerPoint(new L.LatLng(n[1],n[0]));r.fillStyle="#00A3F3",r.beginPath(),r.arc(a.x,a.y,1,0,2*Math.PI,!0,!0),r.closePath(),r.fill()}),console.timeEnd("render")}};L.canvasOverlay().drawing(t).addTo(map)});
